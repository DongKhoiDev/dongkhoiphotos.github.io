<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <h1>ƒê√°nh d·∫•u ·∫£nh y√™u th√≠ch</h1>
  <div style="text-align: center; margin-bottom: 20px;">
    <input type="text" id="driveUrl" placeholder="D√°n li√™n k·∫øt Google Drive c·ªßa b·∫°n"
      style="width: 70%; padding: 10px; font-size: 16px;">
    <button onclick="fetchAlbum()" style="padding: 10px 20px; font-size: 16px; margin-left: 10px;">T·∫£i Album</button>
  </div>
  <div class="album" id="images"></div>
  <div class="floating-buttons">
    <button onclick="saveFavorites()">L∆∞u y√™u th√≠ch</button>
  </div>

  <style>
    body {
      font-family: "Google Sans", sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      color: #333;
      font-size: 24px;
      padding: 20px;
    }

    .album {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      padding: 20px;
      margin: 0 auto;
      max-width: 1200px;
    }

    .image-container {
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s ease-in-out;
    }

    .image-container:hover {
      transform: scale(1.02);
    }

    img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      transition: opacity 0.3s ease-in-out;
    }

    .heart-checkbox {
      display: none;
    }

    .heart-checkbox+label::before {
      content: 'ü§ç';
      font-size: 24px;
      color: #e74c3c;
      position: absolute;
      bottom: 10px;
      right: 10px;
      cursor: pointer;
    }

    .heart-checkbox:checked+label::before {
      content: '‚ù§Ô∏è';
    }

    /* Fixed buttons */
    .floating-buttons {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
    }

    .floating-buttons a,
    .floating-buttons button {
      display: block;
      padding: 10px 20px;
      font-size: 16px;
      text-align: center;
      text-decoration: none;
      border-radius: 5px;
      color: #fff;
      background-color: #007bff;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease;
    }

    .floating-buttons a:hover,
    .floating-buttons button:hover {
      background-color: #0056b3;
    }


    button:hover {
      background-color: #0056b3;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.9);
    }

    .modal-content {
      display: block;
      max-width: 90%;
      max-height: 90%;
      margin: auto;
      margin-top: 5%;
      border-radius: 8px;
    }

    .close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: #fff;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #bbb;
    }

    .floating-buttons {
      position: fixed;
      bottom: 20px;
      /* C√°ch ƒë√°y trang 20px */
      right: 20px;
      /* C√°ch c·∫°nh ph·∫£i 20px */
      display: flex;
      flex-direction: column;
      /* S·∫Øp x·∫øp n√∫t theo chi·ªÅu d·ªçc */
      gap: 10px;
      /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
      z-index: 10;
      /* ƒê·∫£m b·∫£o n√∫t lu√¥n n·∫±m tr√™n c√°c th√†nh ph·∫ßn kh√°c */
    }

    .floating-buttons a,
    .floating-buttons button {
      display: block;
      padding: 10px 20px;
      font-size: 16px;
      text-align: center;
      text-decoration: none;
      border-radius: 5px;
      color: #fff;
      background-color: #007bff;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease;
    }

    .floating-buttons a:hover,
    .floating-buttons button:hover {
      background-color: #0056b3;
    }
  </style>
</head>

<body>
  <h1>Album ·∫£nh y√™u th√≠ch</h1>
  <div class="album" id="images"></div>

  <!-- Floating Buttons -->
  <div class="floating-buttons">
    <button onclick="saveFavorites()">L∆∞u y√™u th√≠ch</button>
  </div>


  <!-- Modal -->
  <div id="myModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img id="img01" class="modal-content" alt="H√¨nh ·∫£nh">
    <div id="caption"></div>
  </div>
  <script>
    function doGet() {
      return HtmlService.createHtmlOutputFromFile('index.html')
        .setTitle('S·∫Øp x·∫øp ·∫£nh theo t√™n');
    } 

    function getImages(folderId) {
      var folder = DriveApp.getFolderById(folderId);
      var files = folder.getFiles();
      var images = [];

      while (files.hasNext()) {
        var file = files.next();
        if (file.getMimeType().startsWith('image/')) {
          images.push({
            id: file.getId(),
            name: file.getName(),
            url: "https://lh3.google.com/u/0/d/" + file.getId()
          });
        }
      }

      // S·∫Øp x·∫øp theo t√™n file (A ‚Üí Z)
      images.sort(function (a, b) {
        return a.name.localeCompare(b.name);
      });

      return images;
    }


    function saveFavorites(favorites) {
      const folderId = favorites[0]?.albumId; // D√πng albumId ƒë·ªÉ l·∫•y t√™n th∆∞ m·ª•c t·ª´ ·∫£nh ƒë·∫ßu ti√™n
      const folder = DriveApp.getFolderById(folderId);
      const albumName = folder.getName(); // L·∫•y t√™n th∆∞ m·ª•c

      const sheet = SpreadsheetApp.openById('1hCCJLlTY-041AjIv9z-ms5LgspGr_8L-t-YJDYvjtx0').getActiveSheet();

      // L∆∞u t√™n album v√†o h√†ng ƒë·∫ßu ti√™n
      sheet.appendRow([`T√™n album: ${albumName}`]);

      // Ghi ti√™u ƒë·ªÅ c·ªôt
      sheet.appendRow(["T√™n ·∫¢nh", "URL ·∫¢nh"]);

      // L∆∞u t·ª´ng ·∫£nh y√™u th√≠ch
      favorites.forEach(fav => {
        sheet.appendRow([fav.name, fav.url]);
      });
    }


    function saveFavorites(favorites) {
      var sheet = SpreadsheetApp.openById('1hCCJLlTY-041AjIv9z-ms5LgspGr_8L-t-YJDYvjtx0').getActiveSheet();
      // Ghi ti√™u ƒë·ªÅ c·ªôt
      sheet.appendRow(["T√™n ·∫¢nh", "URL ·∫¢nh"]);

      favorites.forEach(function (fav) {
        sheet.appendRow([fav.name, fav.url]);
      });
    }

    function extractFolderId(driveUrl) {
      const match = driveUrl.match(/\/folders\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : null;
    }

    function fetchAlbum() {
      const driveUrl = document.getElementById("driveUrl").value;
      const folderId = extractFolderId(driveUrl);

      if (!folderId) {
        alert("URL kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i!");
        return;
      }

      google.script.run.withSuccessHandler(renderImages).getImages(folderId);
    }


    function renderImages(images) {
      const container = document.getElementById("images");
      container.innerHTML = '';
      if (images.length === 0) {
        container.innerHTML = '<p>Kh√¥ng c√≥ h√¨nh ·∫£nh n√†o trong album.</p>';
        return;
      }
      images.forEach((image) => {
        const div = document.createElement('div');
        div.className = 'image-container';
        div.innerHTML = `
          <img src="${image.url}" alt="${image.name}" onclick="openModal('${image.url}', '${image.name}')">
          <input type="checkbox" id="heart-${image.id}" class="heart-checkbox" data-name="${image.name}" data-url="${image.url}">
          <label for="heart-${image.id}"></label>
        `;
        container.appendChild(div);
      });
    }

    function saveFavorites() {

      const checkboxes = document.querySelectorAll("input[type='checkbox']:checked");
      const favorites = Array.from(checkboxes).map((cb) => {
        const name = cb.getAttribute("data-name");
        const url = cb.getAttribute("data-url");
        const numberOnly = name.match(/\d+/g); // Tr√≠ch xu·∫•t ph·∫ßn s·ªë t·ª´ t√™n file


        return {
          name: numberOnly ? numberOnly.join('') : '', // Ch·ªâ l∆∞u ph·∫ßn s·ªë
          url: url,
        };
      });
      google.script.run.saveFavorites(favorites);
      alert("ƒê√£ l∆∞u danh s√°ch y√™u th√≠ch!");
    }

    function openModal(url, name) {
      const modal = document.getElementById("myModal");
      const modalImg = document.getElementById("img01");
      const captionText = document.getElementById("caption");
      const downloadButton = document.getElementById("downloadButton");

      modal.style.display = "block";
      modalImg.src = url; // Hi·ªÉn th·ªã ·∫£nh
      captionText.innerHTML = name; // G√°n t√™n ·∫£nh l√†m ch√∫ th√≠ch
    }

    // ƒê√≥ng modal khi nh·∫•p ra ngo√†i
    const modal = document.getElementById("myModal");
    modal.onclick = function (event) {
      if (event.target === modal) {
        closeModal();
      }
    };

    // ƒê√≥ng modal khi nh·∫•n v√†o n√∫t "X"
    function closeModal() {
      modal.style.display = "none";
    }


    loadImages();
  </script>
</body>

</html>
